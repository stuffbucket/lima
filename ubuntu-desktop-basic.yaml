# Ubuntu Desktop - Simple VZ version
# Start with default Ubuntu, manually install desktop

vmType: vz

video:
  display: "vz"
  vz:
    width: 1440
    height: 900

audio:
  device: "vz"

images:
  - location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-amd64.img"
    arch: "x86_64"
  - location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-arm64.img"
    arch: "aarch64"

cpus: 4
memory: "8GiB"
disk: "50GiB"

mounts:
  - location: "~"
    writable: false
  - location: "/tmp/lima"
    writable: true

ssh:
  localPort: 0
  loadDotSSHPubKeys: true

hostResolver:
  enabled: true

provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail
      
      # Try to load virtio-sound module if available
      if modinfo virtio_snd >/dev/null 2>&1; then
        modprobe virtio_snd || true
        modprobe snd_virtio || true
      fi
      
      # Configure LightDM auto-login for GUI
      if command -v lightdm >/dev/null 2>&1; then
        mkdir -p /etc/lightdm/lightdm.conf.d
        cat > /etc/lightdm/lightdm.conf.d/50-autologin.conf <<EOF
      [Seat:*]
      autologin-user=${LIMA_CIDATA_USER}
      autologin-user-timeout=0
      EOF
        systemctl restart lightdm || true
      fi

message: |
  Basic Ubuntu with VZ display/audio configured.
  
  Note: VZ audio requires virtio-sound kernel driver. Ubuntu 24.04 compiles this
  driver but doesn't ship the .ko module files. Apple Virtualization.framework
  only supports virtio-sound (no Intel HDA/AC97 alternative available).
  
  Audio hardware is present but won't work until the driver is installed.
  For working audio, use QEMU+SPICE or try Fedora/Alpine distros which may
  ship the virtio_snd module.
  
  To install desktop environment, SSH in and run:
    lima sudo apt-get update
    lima sudo apt-get install -y xubuntu-desktop
    lima sudo systemctl set-default graphical.target
    lima sudo systemctl reboot
  
  Then launch GUI:
    limactl show-gui ubuntu-desktop
